#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Interface Streamlit pour l'outil de traduction de fichiers SRT
"""

import streamlit as st
import tempfile
import os
from pathlib import Path
import requests
import time
from srt_translator import SRTTranslator

# Dictionnaire de traductions
TRANSLATIONS = {
    'fr': {
        'title': 'üé¨ Traducteur de Sous-titres SRT',
        'config': '‚öôÔ∏è Configuration',
        'ollama': 'ü§ñ Ollama',
        'ollama_url': 'URL Ollama',
        'ollama_url_help': "L'URL de votre instance Ollama",
        'test_connection': 'üîç Tester la connexion',
        'testing_connection': 'Test de connexion...',
        'connection_success': '‚úÖ Connexion r√©ussie !',
        'models_available': 'üìã Mod√®les disponibles: {}',
        'connection_failed': '‚ùå Impossible de se connecter √† Ollama',
        'model_name': 'Mod√®le Ollama',
        'model_help': 'Nom du mod√®le √† utiliser pour la traduction',
        'languages': 'üåç Langues',
        'source_lang': 'Langue source',
        'target_lang': 'Langue cible',
        'about': '‚ÑπÔ∏è √Ä propos',
        'about_text': '''**Traducteur SRT** vous permet de traduire facilement vos fichiers de sous-titres.

**Fonctionnalit√©s:**
- üöÄ Traduction rapide avec Ollama
- üìÅ Support des formats SRT
- üéØ Interface intuitive
- üíæ T√©l√©chargement direct du r√©sultat''',
        'upload_section': 'üìÇ Upload du fichier SRT',
        'choose_file': 'Choisissez votre fichier SRT',
        'choose_file_help': 'S√©lectionnez le fichier de sous-titres √† traduire',
        'file_loaded': '‚úÖ Fichier charg√©: **{}** ({} octets)',
        'preview_file': 'üëÄ Aper√ßu du fichier',
        'file_truncated': '... (fichier tronqu√© pour l\'aper√ßu)',
        'encoding_warning': '‚ö†Ô∏è Impossible de d√©coder le fichier en UTF-8. La traduction tentera d\'autres encodages.',
        'start_translation': 'üöÄ Lancer la traduction',
        'ollama_connection_error': '‚ùå Impossible de se connecter √† Ollama. V√©rifiez votre configuration.',
        'translation_progress': 'üîÑ Traduction en cours...',
        'entries_found': 'üìã {} entr√©es trouv√©es',
        'translating_entry': 'Traduction {}/{}: {}...',
        'translation_completed': '‚úÖ Traduction termin√©e !',
        'translation_success': 'üéâ Traduction termin√©e avec succ√®s !',
        'translation_error': '‚ùå Erreur lors de la traduction: {}',
        'no_entries_found': 'Aucune entr√©e SRT trouv√©e dans le fichier.',
        'result_section': 'üì• R√©sultat',
        'file_ready': '‚úÖ Fichier traduit pr√™t !',
        'preview_translation': 'üëÄ Aper√ßu de la traduction',
        'preview_truncated': '... (aper√ßu tronqu√©)',
        'download_file': 'üíæ T√©l√©charger le fichier traduit',
        'statistics': 'üìä Statistiques',
        'total_lines': 'Lignes totales',
        'translated_entries': 'Entr√©es traduites',
        'upload_info': 'üëÜ Uploadez un fichier SRT et lancez la traduction pour voir le r√©sultat ici',
        'usage_guide': 'üìñ Guide d\'utilisation',
        'usage_steps': '''**√âtapes simples :**

1. **Configurer Ollama** dans la barre lat√©rale
2. **Choisir les langues** source et cible
3. **Uploader votre fichier SRT**
4. **Cliquer sur "Lancer la traduction"**
5. **T√©l√©charger le r√©sultat** !

**Format SRT support√© :**
```
1
00:00:01,000 --> 00:00:04,000
Hello, world!

2
00:00:05,000 --> 00:00:08,000
How are you today?
```''',
        'interface_language': 'üåê Langue de l\'interface'
    },
    'en': {
        'title': 'üé¨ SRT Subtitle Translator',
        'config': '‚öôÔ∏è Configuration',
        'ollama': 'ü§ñ Ollama',
        'ollama_url': 'Ollama URL',
        'ollama_url_help': 'The URL of your Ollama instance',
        'test_connection': 'üîç Test connection',
        'testing_connection': 'Testing connection...',
        'connection_success': '‚úÖ Connection successful!',
        'models_available': 'üìã Available models: {}',
        'connection_failed': '‚ùå Unable to connect to Ollama',
        'model_name': 'Ollama Model',
        'model_help': 'Name of the model to use for translation',
        'languages': 'üåç Languages',
        'source_lang': 'Source language',
        'target_lang': 'Target language',
        'about': '‚ÑπÔ∏è About',
        'about_text': '''**SRT Translator** allows you to easily translate your subtitle files.

**Features:**
- üöÄ Fast translation with Ollama
- üìÅ SRT format support
- üéØ Intuitive interface
- üíæ Direct result download''',
        'upload_section': 'üìÇ SRT File Upload',
        'choose_file': 'Choose your SRT file',
        'choose_file_help': 'Select the subtitle file to translate',
        'file_loaded': '‚úÖ File loaded: **{}** ({} bytes)',
        'preview_file': 'üëÄ File preview',
        'file_truncated': '... (file truncated for preview)',
        'encoding_warning': '‚ö†Ô∏è Unable to decode file as UTF-8. Translation will try other encodings.',
        'start_translation': 'üöÄ Start translation',
        'ollama_connection_error': '‚ùå Unable to connect to Ollama. Check your configuration.',
        'translation_progress': 'üîÑ Translation in progress...',
        'entries_found': 'üìã {} entries found',
        'translating_entry': 'Translating {}/{}: {}...',
        'translation_completed': '‚úÖ Translation completed!',
        'translation_success': 'üéâ Translation completed successfully!',
        'translation_error': '‚ùå Translation error: {}',
        'no_entries_found': 'No SRT entries found in the file.',
        'result_section': 'üì• Result',
        'file_ready': '‚úÖ Translated file ready!',
        'preview_translation': 'üëÄ Translation preview',
        'preview_truncated': '... (preview truncated)',
        'download_file': 'üíæ Download translated file',
        'statistics': 'üìä Statistics',
        'total_lines': 'Total lines',
        'translated_entries': 'Translated entries',
        'upload_info': 'üëÜ Upload an SRT file and start translation to see the result here',
        'usage_guide': 'üìñ Usage Guide',
        'usage_steps': '''**Simple steps:**

1. **Configure Ollama** in the sidebar
2. **Choose languages** source and target
3. **Upload your SRT file**
4. **Click "Start translation"**
5. **Download the result**!

**Supported SRT format:**
```
1
00:00:01,000 --> 00:00:04,000
Hello, world!

2
00:00:05,000 --> 00:00:08,000
How are you today?
```''',
        'interface_language': 'üåê Interface Language'
    }
}

def get_text(key, lang='fr'):
    """R√©cup√®re le texte traduit selon la langue s√©lectionn√©e"""
    return TRANSLATIONS.get(lang, TRANSLATIONS['fr']).get(key, key)

# Configuration de la page
st.set_page_config(
    page_title="Traducteur SRT", 
    page_icon="üé¨", 
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS pour personnaliser l'apparence
st.markdown("""
<style>
.main-header {
    text-align: center;
    color: #2E86AB;
    padding: 1rem 0;
    border-bottom: 2px solid #f0f2f6;
    margin-bottom: 2rem;
}

.upload-box {
    border: 2px dashed #2E86AB;
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    margin: 1rem 0;
    background-color: #f8f9fa;
}

.success-box {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 5px;
    padding: 1rem;
    margin: 1rem 0;
}

.error-box {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 5px;
    padding: 1rem;
    margin: 1rem 0;
}

.sidebar .sidebar-content {
    background-color: #f8f9fa;
}

.stProgress .st-bo {
    background-color: #2E86AB;
}
</style>
""", unsafe_allow_html=True)

def check_ollama_connection(url):
    """V√©rifie la connexion √† Ollama"""
    try:
        response = requests.get(f"{url}/api/tags", timeout=5)
        return response.status_code == 200
    except:
        return False

def get_available_models(url):
    """R√©cup√®re la liste des mod√®les disponibles"""
    try:
        response = requests.get(f"{url}/api/tags", timeout=5)
        if response.status_code == 200:
            models = response.json().get('models', [])
            return [model['name'] for model in models]
        return []
    except:
        return []

def main():
    # Initialiser la langue dans session_state si elle n'existe pas
    if 'ui_language' not in st.session_state:
        st.session_state.ui_language = 'fr'
    
    # Sidebar pour la configuration
    with st.sidebar:
        # S√©lecteur de langue en haut de la sidebar
        ui_lang = st.selectbox(
            "üåê Language / Langue",
            options=['fr', 'en'],
            format_func=lambda x: "üá´üá∑ Fran√ßais" if x == 'fr' else "üá¨üáß English",
            index=0 if st.session_state.ui_language == 'fr' else 1,
            key="language_selector"
        )
        
        # Mettre √† jour la langue si elle a chang√©
        if ui_lang != st.session_state.ui_language:
            st.session_state.ui_language = ui_lang
            st.rerun()
        
        st.divider()
        
        st.header(get_text("config", ui_lang))
    
        # En-t√™te principal
    st.markdown(f'<h1 class="main-header">{get_text("title", ui_lang)}</h1>', unsafe_allow_html=True)
    
    # Continuer avec la sidebar
    with st.sidebar:
        # Configuration d'Ollama
        st.subheader(get_text("ollama", ui_lang))
        ollama_url = st.text_input(
            get_text("ollama_url", ui_lang), 
            value="http://localhost:11434",
            help=get_text("ollama_url_help", ui_lang)
        )
        
        # Test de connexion
        if st.button(get_text("test_connection", ui_lang)):
            with st.spinner(get_text("testing_connection", ui_lang)):
                if check_ollama_connection(ollama_url):
                    st.success(get_text("connection_success", ui_lang))
                    
                    # R√©cup√©rer les mod√®les disponibles
                    models = get_available_models(ollama_url)
                    if models:
                        st.info(get_text("models_available", ui_lang).format(', '.join(models)))
                else:
                    st.error(get_text("connection_failed", ui_lang))
        
        # S√©lection du mod√®le
        model_name = st.text_input(
            get_text("model_name", ui_lang), 
            value="gemma3:12b",
            help=get_text("model_help", ui_lang)
        )
        
        st.divider()
        
        # Configuration des langues
        st.subheader(get_text("languages", ui_lang))
        
        col1, col2 = st.columns(2)
        with col1:
            source_lang = st.selectbox(
                get_text("source_lang", ui_lang),
                ["anglais", "fran√ßais", "espagnol", "italien", "allemand", "portugais", "chinois", "japonais", "cor√©en", "russe"],
                index=0
            )
        
        with col2:
            target_lang = st.selectbox(
                get_text("target_lang", ui_lang),
                ["fran√ßais", "anglais", "espagnol", "italien", "allemand", "portugais", "chinois", "japonais", "cor√©en", "russe"],
                index=0
            )
        
        st.divider()
        
        # Informations
        st.subheader(get_text("about", ui_lang))
        st.markdown(get_text("about_text", ui_lang))
    
    # Zone principale
    col1, col2 = st.columns([3, 2])
    
    with col1:
        st.header(get_text("upload_section", ui_lang))
        
        # Zone d'upload
        uploaded_file = st.file_uploader(
            get_text("choose_file", ui_lang),
            type=['srt'],
            help=get_text("choose_file_help", ui_lang)
        )
        
        if uploaded_file is not None:
            # Affichage des informations du fichier
            st.success(get_text("file_loaded", ui_lang).format(uploaded_file.name, uploaded_file.size))
            
            # Pr√©visualisation du contenu
            with st.expander(get_text("preview_file", ui_lang), expanded=False):
                try:
                    content = uploaded_file.read().decode('utf-8')
                    uploaded_file.seek(0)  # Reset file pointer
                    
                    # Afficher les premi√®res lignes
                    lines = content.split('\n')[:20]
                    st.code('\n'.join(lines), language='text')
                    
                    if len(content.split('\n')) > 20:
                        st.info(get_text("file_truncated", ui_lang))
                        
                except UnicodeDecodeError:
                    st.warning(get_text("encoding_warning", ui_lang))
            
            # Bouton de traduction
            if st.button(get_text("start_translation", ui_lang), type="primary", use_container_width=True):
                # V√©rifier la connexion Ollama
                if not check_ollama_connection(ollama_url):
                    st.error(get_text("ollama_connection_error", ui_lang))
                    return
                
                # Traitement de la traduction
                with st.spinner(get_text("translation_progress", ui_lang)):
                    try:
                        # Cr√©er des fichiers temporaires
                        with tempfile.NamedTemporaryFile(mode='w+b', suffix='.srt', delete=False) as input_temp:
                            input_temp.write(uploaded_file.read())
                            input_temp_path = input_temp.name
                        
                        with tempfile.NamedTemporaryFile(mode='w+', suffix='.srt', delete=False, encoding='utf-8') as output_temp:
                            output_temp_path = output_temp.name
                        
                        # R√©initialiser le pointeur du fichier
                        uploaded_file.seek(0)
                        
                        # Cr√©er le traducteur
                        translator = SRTTranslator(ollama_url)
                        translator.model = model_name
                        
                        # Affichage de la progression
                        progress_bar = st.progress(0)
                        status_text = st.empty()
                        
                        # Hook pour suivre la progression (modification temporaire)
                        original_translate = translator.translate_srt_file
                        
                        def translate_with_progress(input_file, output_file, source_lang, target_lang):
                            # Lire et parser le fichier
                            try:
                                with open(input_file, 'r', encoding='utf-8') as f:
                                    content = f.read()
                            except UnicodeDecodeError:
                                try:
                                    with open(input_file, 'r', encoding='cp1252') as f:
                                        content = f.read()
                                except:
                                    with open(input_file, 'r', encoding='latin-1') as f:
                                        content = f.read()
                            
                            entries = translator.parse_srt(content)
                            
                            if not entries:
                                st.error(get_text("no_entries_found", ui_lang))
                                return
                            
                            status_text.text(get_text("entries_found", ui_lang).format(len(entries)))
                            
                            # Traduire chaque entr√©e avec progression
                            translated_entries = []
                            for i, entry in enumerate(entries):
                                progress = (i + 1) / len(entries)
                                progress_bar.progress(progress)
                                status_text.text(get_text("translating_entry", ui_lang).format(i+1, len(entries), entry['text'][:50]))
                                
                                translated_text = translator.translate_text(
                                    entry['text'], 
                                    source_lang, 
                                    target_lang
                                )
                                
                                translated_entries.append({
                                    'number': entry['number'],
                                    'timestamp': entry['timestamp'],
                                    'text': translated_text
                                })
                            
                            # √âcrire le fichier traduit
                            with open(output_file, 'w', encoding='utf-8') as f:
                                for entry in translated_entries:
                                    f.write(f"{entry['number']}\n")
                                    f.write(f"{entry['timestamp']}\n")
                                    f.write(f"{entry['text']}\n\n")
                            
                            progress_bar.progress(1.0)
                            status_text.text(get_text("translation_completed", ui_lang))
                        
                        # Lancer la traduction
                        translate_with_progress(input_temp_path, output_temp_path, source_lang, target_lang)
                        
                        # Lire le fichier traduit
                        with open(output_temp_path, 'r', encoding='utf-8') as f:
                            translated_content = f.read()
                        
                        # Stocker dans la session
                        st.session_state['translated_content'] = translated_content
                        st.session_state['original_filename'] = uploaded_file.name
                        
                        # Nettoyage
                        os.unlink(input_temp_path)
                        os.unlink(output_temp_path)
                        
                        st.success(get_text("translation_success", ui_lang))
                        
                    except Exception as e:
                        st.error(get_text("translation_error", ui_lang).format(str(e)))
                        # Nettoyage en cas d'erreur
                        try:
                            os.unlink(input_temp_path)
                            os.unlink(output_temp_path)
                        except:
                            pass
    
    with col2:
        st.header(get_text("result_section", ui_lang))
        
        if 'translated_content' in st.session_state and st.session_state['translated_content']:
            st.success(get_text("file_ready", ui_lang))
            
            # Aper√ßu du r√©sultat
            with st.expander(get_text("preview_translation", ui_lang), expanded=True):
                lines = st.session_state['translated_content'].split('\n')[:15]
                st.code('\n'.join(lines), language='text')
                
                if len(st.session_state['translated_content'].split('\n')) > 15:
                    st.info(get_text("preview_truncated", ui_lang))
            
            # Nom du fichier de sortie
            original_name = st.session_state.get('original_filename', 'subtitle.srt')
            name_without_ext = Path(original_name).stem
            output_filename = f"{name_without_ext}_{target_lang}.srt"
            
            # Bouton de t√©l√©chargement
            st.download_button(
                label=get_text("download_file", ui_lang),
                data=st.session_state['translated_content'],
                file_name=output_filename,
                mime="text/plain",
                type="primary",
                use_container_width=True
            )
            
            # Statistiques
            st.subheader(get_text("statistics", ui_lang))
            lines_count = len([line for line in st.session_state['translated_content'].split('\n') if line.strip()])
            entries_count = st.session_state['translated_content'].count('\n\n')
            
            col_stat1, col_stat2 = st.columns(2)
            with col_stat1:
                st.metric(get_text("total_lines", ui_lang), lines_count)
            with col_stat2:
                st.metric(get_text("translated_entries", ui_lang), entries_count)
        
        else:
            st.info(get_text("upload_info", ui_lang))
            
            # Exemple d'utilisation
            with st.expander(get_text("usage_guide", ui_lang)):
                st.markdown(get_text("usage_steps", ui_lang))

if __name__ == "__main__":
    main() 